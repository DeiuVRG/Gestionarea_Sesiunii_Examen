using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using Laborator4_AI.Domain.Models.Commands;
using Laborator4_AI.Domain.Models.Events;
using Laborator4_AI.Domain.Models.ValueObjects;
using Laborator4_AI.Domain.Workflows;
using Laborator4_AI.Infrastructure;

namespace Laborator4_AI
{
    class Program
    {
        static void Main(string[] args)
        {
            Console.WriteLine("‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó");
            Console.WriteLine("‚ïë    SISTEM DE GESTIONARE A SESIUNII DE EXAMENE - DEMONSTRA»öIE   ‚ïë");
            Console.WriteLine("‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù");
            Console.WriteLine();

            // PostgreSQL connection string
            // Mac: localhost cu userul curent, Windows: localhost sau IP-ul serverului cu user postgres
            var connectionString = "Host=localhost;Database=exam_scheduling;Username=deiuvrg";
            
            var db = new SchedulingDbContext(connectionString);
            
            // Recreate database for demo (clean start)
            db.Database.EnsureDeleted();
            db.Database.EnsureCreated();
            db.EnsureSeeded();

            Console.WriteLine($"üìÇ Database: PostgreSQL @ localhost/exam_scheduling");
            
            // VERIFICARE EXPLICITƒÇ: citim sƒÉlile din baza de date
            var roomsFromDb = db.Rooms.OrderBy(r => r.Number).ToList();
            Console.WriteLine($"üè´ Available rooms: {roomsFromDb.Count}");
            Console.WriteLine("üìã Rooms from database:");
            foreach (var room in roomsFromDb)
            {
                Console.WriteLine($"   - {room.Number} (Capacity: {room.Capacity})");
            }
            Console.WriteLine();

            var coursesCatalog = new Dictionary<string, DateTime>
            {
                { "PSSC", DateTime.Today.AddDays(-30) },
                { "BD", DateTime.Today.AddDays(-25) },
                { "POO", DateTime.Today.AddDays(-20) },
                { "MATH1", DateTime.Today.AddDays(-15) }
            };

            var students = new HashSet<string> { "LM12345", "LM12346", "LM12347", "LM12348", "LM12349" };

            PrintSection("WORKFLOW 1: PROGRAMARE EXAMENE");
            RunExamSchedulingWorkflow(db, coursesCatalog);
            Console.WriteLine($"   ‚ÑπÔ∏è  DB now has {db.Reservations.Count()} exam(s) scheduled");

            PrintSection("WORKFLOW 2: √éNSCRIERE STUDEN»öI");
            RunStudentRegistrationWorkflow(db, students);
            Console.WriteLine($"   ‚ÑπÔ∏è  DB now has {db.StudentRegistrations.Count()} student registration(s)");

            PrintSection("WORKFLOW 3: PUBLICARE NOTE");
            RunPublishGradesWorkflow(db, students);
            Console.WriteLine($"   ‚ÑπÔ∏è  DB now has {db.ExamGrades.Count()} grade(s) published");

            PrintSection("WORKFLOW 4: CONTESTA»öII");
            RunContestationWorkflow(db);
            Console.WriteLine($"   ‚ÑπÔ∏è  DB now has {db.Contestations.Count()} contestation(s)");

            Console.WriteLine();
            Console.WriteLine("‚úÖ DEMONSTRA»öIE COMPLETƒÇ!");
            Console.WriteLine();
            
            // VERIFICARE FINALƒÇ - citim toate datele din DB
            Console.WriteLine("üîç VERIFICARE FINALƒÇ - Date din PostgreSQL:");
            Console.WriteLine($"   üìä Reservations: {db.Reservations.Count()}");
            Console.WriteLine($"   üìä StudentRegistrations: {db.StudentRegistrations.Count()}");
            Console.WriteLine($"   üìä ExamGrades: {db.ExamGrades.Count()}");
            Console.WriteLine($"   üìä Contestations: {db.Contestations.Count()}");
            
            if (db.ExamGrades.Any())
            {
                Console.WriteLine("\n   üìù Grades from DB:");
                foreach (var grade in db.ExamGrades.OrderBy(g => g.StudentRegNumber))
                {
                    Console.WriteLine($"      ‚Ä¢ {grade.StudentRegNumber}: {grade.Grade:F2}");
                }
            }
            
            Console.WriteLine();
            Console.WriteLine("ApasƒÉ orice tastƒÉ...");
            Console.ReadKey();
        }

        static void RunExamSchedulingWorkflow(SchedulingDbContext db, Dictionary<string, DateTime> coursesCatalog)
        {
            var workflow = new ScheduleExamWorkflow();
            // Use June 2026 for valid exam session
            var futureDate = new DateTime(2026, 6, 15);

            Console.WriteLine("\nüü¢ Test 1: Programare examen PSSC (VALID)");
            var cmd1 = new ScheduleExamCommand
            {
                CourseCode = "PSSC",
                ProposedDate1 = futureDate.ToString("yyyy-MM-dd"),
                Duration = "120",
                ExpectedStudents = "25"
            };

            var result1 = workflow.Execute(cmd1,
                code => coursesCatalog.ContainsKey(code.Value),
                code => coursesCatalog[code.Value],
                (date, duration, capacity) => ExamSchedulingRepository.FindAvailableRooms(db, date, duration, capacity),
                (room, date, duration) =>
                {
                    CourseCode.TryCreate(cmd1.CourseCode, out var c, out var _);
                    return ExamSchedulingRepository.ReserveRoom(db, room, date, duration, c!);
                });
            PrintExamSchedulingResult(result1);

            Console.WriteLine("\nüî¥ Test 2: Cod curs invalid");
            var cmd2 = new ScheduleExamCommand { CourseCode = "invalid", ProposedDate1 = futureDate.ToString("yyyy-MM-dd"), Duration = "120", ExpectedStudents = "25" };
            var result2 = workflow.Execute(cmd2, code => false, code => DateTime.Today, (d, dur, c) => Enumerable.Empty<RoomNumber>(), (r, d, dur) => false);
            PrintExamSchedulingResult(result2);
        }

        static void RunStudentRegistrationWorkflow(SchedulingDbContext db, HashSet<string> students)
        {
            var workflow = new RegisterStudentWorkflow();
            
            // Check if there are any reservations
            if (!db.Reservations.Any())
            {
                Console.WriteLine("\n‚ö†Ô∏è  No exams scheduled. Skipping student registration tests.");
                return;
            }
            
            var examDate = db.Reservations.First().Date.ToString("yyyy-MM-dd");

            // √énregistrƒÉm to»õi studen»õii pentru examen
            foreach (var studentId in new[] { "LM12345", "LM12346", "LM12347" })
            {
                Console.WriteLine($"\nüü¢ √énscriere student {studentId} la examen");
                var cmd = new RegisterStudentCommand { StudentRegistrationNumber = studentId, CourseCode = "PSSC", ExamDate = examDate };
                var result = workflow.Execute(cmd,
                    student => students.Contains(student.Value),
                    (course, date) => (ExamSchedulingRepository.ExamExists(db, course, date), ExamSchedulingRepository.GetExamRoom(db, course, date)),
                    (student, date) => StudentRegistrationRepository.GetStudentExamsOnDate(db, student, date),
                    (course, date) => ExamSchedulingRepository.GetExamRoom(db, course, date),
                    (student, course, date) => StudentRegistrationRepository.IsStudentRegistered(db, student, course, date),
                    (student, course, date, room) => StudentRegistrationRepository.PersistRegistration(db, student, course, date, room));
                PrintStudentRegistrationResult(result);
            }
        }

        static void RunPublishGradesWorkflow(SchedulingDbContext db, HashSet<string> students)
        {
            var workflow = new PublishGradesWorkflow();
            
            // Check if there are any reservations
            if (!db.Reservations.Any())
            {
                Console.WriteLine("\n‚ö†Ô∏è  No exams scheduled. Skipping grading tests.");
                return;
            }
            
            var examDate = db.Reservations.First().Date.ToString("yyyy-MM-dd");

            Console.WriteLine("\nüü¢ Test 1: Publicare note (VALID)");
            var cmd1 = new PublishGradesCommand
            {
                CourseCode = "PSSC",
                ExamDate = examDate,
                StudentGrades = new List<StudentGradeInput>
                {
                    new() { StudentRegistrationNumber = "LM12345", Grade = "8.50" },
                    new() { StudentRegistrationNumber = "LM12346", Grade = "6.00" },
                    new() { StudentRegistrationNumber = "LM12347", Grade = "4.50" }
                }
            };
            var result1 = workflow.Execute(cmd1,
                (course, date) => ExamSchedulingRepository.ExamExists(db, course, date),
                (student, course, date) => StudentRegistrationRepository.IsStudentRegistered(db, student, course, date),
                grading => ExamGradingRepository.PersistGrades(db, grading));
            PrintGradingResult(result1);
        }

        static void RunContestationWorkflow(SchedulingDbContext db)
        {
            var workflow = new FileContestationWorkflow();
            
            // Check if there are any reservations
            if (!db.Reservations.Any())
            {
                Console.WriteLine("\n‚ö†Ô∏è  No exams scheduled. Skipping contestation tests.");
                return;
            }
            
            var examDate = db.Reservations.First().Date.ToString("yyyy-MM-dd");

            Console.WriteLine("\nüü¢ Test 1: Contesta»õie (VALID)");
            var cmd1 = new FileContestationCommand
            {
                StudentRegistrationNumber = "LM12347",
                CourseCode = "PSSC",
                ExamDate = examDate,
                Reason = "Consider cƒÉ problema 3 a fost evaluatƒÉ incorect."
            };
            var result1 = workflow.Execute(cmd1,
                (student, course, date) => StudentRegistrationRepository.IsStudentRegistered(db, student, course, date),
                (course, date) => ExamGradingRepository.GetGradesPublishedDate(db, course, date),
                (student, course, date, reason) => ContestationRepository.PersistContestation(db, student, course, date, reason));
            PrintContestationResult(result1);
        }

        static void PrintSection(string title)
        {
            Console.WriteLine($"\n‚ïê‚ïê‚ïê‚ïê {title} ‚ïê‚ïê‚ïê‚ïê");
        }

        static void PrintExamSchedulingResult(IExamSchedulingEvent evt)
        {
            if (evt is ExamScheduledEvent success)
            {
                Console.WriteLine($"   ‚úÖ Curs: {success.Course}, Data: {success.Date}, Sala: {success.Room}");
            }
            else if (evt is ExamSchedulingFailedEvent failure)
            {
                Console.WriteLine($"   ‚ùå {failure.CourseCode}: {string.Join("; ", failure.Reasons)}");
            }
        }

        static void PrintStudentRegistrationResult(IStudentRegistrationEvent evt)
        {
            if (evt is StudentRegisteredEvent success)
            {
                Console.WriteLine($"   ‚úÖ Student: {success.Student}, Curs: {success.Course}, Sala: {success.Room}");
            }
            else if (evt is StudentRegistrationFailedEvent failure)
            {
                Console.WriteLine($"   ‚ùå {failure.StudentRegistrationNumber}: {string.Join("; ", failure.Reasons)}");
            }
        }

        static void PrintGradingResult(IExamGradingEvent evt)
        {
            if (evt is GradesPublishedEvent success)
            {
                Console.WriteLine($"   ‚úÖ Curs: {success.Course}, Total: {success.TotalStudents}, Promova»õi: {success.PassedStudents} ({success.PassRate}%)");
            }
            else if (evt is ExamGradingFailedEvent failure)
            {
                Console.WriteLine($"   ‚ùå {failure.CourseCode}: {string.Join("; ", failure.Reasons)}");
            }
        }

        static void PrintContestationResult(IContestationEvent evt)
        {
            if (evt is ContestationFiledEvent success)
            {
                Console.WriteLine($"   ‚úÖ Student: {success.Student}, Curs: {success.Course}, Motiv: {success.Reason}");
            }
            else if (evt is ContestationFailedEvent failure)
            {
                Console.WriteLine($"   ‚ùå {failure.StudentRegistrationNumber}: {string.Join("; ", failure.Reasons)}");
            }
        }
    }
}
